/*!     jquery-comments.js 1.5.0
 *
 *     (c) 2017 Joona TykkylÃ¤inen, Viima Solutions Oy
 *     jquery-comments may be freely distributed under the MIT license.
 *     For all details and documentation:
 *     http://viima.github.io/jquery-comments/
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=function(e,n){return void 0===n&&(n="undefined"!=typeof window?require("jquery"):require("jquery")(e)),t(n),n}:t(jQuery)}(function(t){var e={$el:null,commentsById:{},dataFetched:!1,currentSortKey:"",options:{},events:{click:"closeDropdowns",paste:"preSavePastedAttachments","keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li[data-sort-key]":"navigationElementClicked","click .navigation li.title":"toggleNavigationDropdown","click .commenting-field.main .textarea":"showMainCommentingField","click .commenting-field.main .close":"hideMainCommentingField","click .commenting-field .textarea":"increaseTextareaHeight","change .commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .commenting-field:not(.main) .close":"removeCommentingField","click .commenting-field .send.enabled":"postComment","click .commenting-field .update.enabled":"putComment","click .commenting-field .delete.enabled":"deleteComment","click .commenting-field .attachments .attachment .delete":"preDeleteAttachment",'change .commenting-field .upload.enabled input[type="file"]':"fileInputChanged","click li.comment button.upvote":"upvoteComment","click li.comment button.delete.enabled":"deleteComment","click li.comment .hashtag":"hashtagClicked","click li.comment .ping":"pingClicked","click li.comment ul.child-comments .toggle-all":"toggleReplies","click li.comment button.reply":"replyButtonClicked","click li.comment button.edit":"editButtonClicked",dragenter:"showDroppableOverlay","dragenter .droppable-overlay":"handleDragEnter","dragleave .droppable-overlay":"handleDragLeaveForOverlay","dragenter .droppable-overlay .droppable":"handleDragEnter","dragleave .droppable-overlay .droppable":"handleDragLeaveForDroppable","dragover .droppable-overlay":"handleDragOverForOverlay","drop .droppable-overlay":"handleDrop","click .dropdown.autocomplete":"stopPropagation","mousedown .dropdown.autocomplete":"stopPropagation","touchstart .dropdown.autocomplete":"stopPropagation"},getDefaultOptions:function(){return{profilePictureURL:"",currentUserIsAdmin:!1,currentUserId:null,spinnerIconURL:"",upvoteIconURL:"",replyIconURL:"",uploadIconURL:"",attachmentIconURL:"",noCommentsIconURL:"",closeIconURL:"",textareaPlaceholderText:"Add a comment",newestText:"Newest",oldestText:"Oldest",popularText:"Popular",attachmentsText:"Attachments",sendText:"Send",replyText:"Reply",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",newText:"New",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",noAttachmentsText:"No attachments",attachmentDropText:"Drop files here",textFormatter:function(t){return t},enableReplying:!0,enableEditing:!0,enableUpvoting:!0,enableDeleting:!0,enableAttachments:!1,enableHashtags:!1,enablePinging:!1,enableDeletingCommentWithReplies:!1,enableNavigation:!0,postCommentOnEnter:!1,forceResponsive:!1,readOnly:!1,defaultNavigationSortKey:"newest",highlightColor:"#2793e6",deleteButtonColor:"#C9302C",scrollContainer:this.$el,roundProfilePictures:!1,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",attachments:"attachments",pings:"pings",creator:"creator",fullname:"fullname",profilePictureURL:"profile_picture_url",isNew:"is_new",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},searchUsers:function(t,e,n){e([])},getComments:function(t,e){t([])},postComment:function(t,e,n){e(t)},putComment:function(t,e,n){e(t)},deleteComment:function(t,e,n){e()},upvoteComment:function(t,e,n){e(t)},validateAttachments:function(t,e){return e(t)},hashtagClicked:function(t){},pingClicked:function(t){},refresh:function(){},timeFormatter:function(t){return new Date(t).toLocaleDateString()}}},init:function(e,n){var a;this.$el=t(n),this.$el.addClass("jquery-comments"),this.undelegateEvents(),this.delegateEvents(),a=navigator.userAgent||navigator.vendor||window.opera,(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)),t.browser.mobile&&this.$el.addClass("mobile"),this.options=t.extend(!0,{},this.getDefaultOptions(),e),this.options.readOnly&&this.$el.addClass("read-only"),this.currentSortKey=this.options.defaultNavigationSortKey,this.createCssDeclarations(),this.fetchDataAndRender()},delegateEvents:function(){this.bindEvents(!1)},undelegateEvents:function(){this.bindEvents(!0)},bindEvents:function(e){var n=e?"off":"on";for(var a in this.events){var i=a.split(" ")[0],o=a.split(" ").slice(1).join(" "),s=this.events[a].split(" ");for(var r in s)if(s.hasOwnProperty(r)){var l=this[s[r]];l=t.proxy(l,this),""==o?this.$el[n](i,l):this.$el[n](i,o,l)}}},fetchDataAndRender:function(){var e=this;this.commentsById={},this.$el.empty(),this.createHTML(),this.options.getComments(function(n){var a=n.map(function(t){return e.createCommentModel(t)});e.sortComments(a,"oldest"),t(a).each(function(t,n){e.addCommentToDataModel(n)}),e.dataFetched=!0,e.render()})},fetchNext:function(){var e=this,n=this.createSpinner();this.$el.find("ul#comment-list").append(n);this.options.getComments(function(a){t(a).each(function(t,n){e.createComment(n)}),n.remove()},function(){n.remove()})},createCommentModel:function(t){var e=this.applyInternalMappings(t);return e.childs=[],e.hasAttachments=function(){return e.attachments.length>0},e},addCommentToDataModel:function(t){t.id in this.commentsById||(this.commentsById[t.id]=t,t.parent&&this.getOutermostParent(t.parent).childs.push(t.id))},updateCommentModel:function(e){t.extend(this.commentsById[e.id],e)},render:function(){this.dataFetched&&(this.showActiveContainer(),this.createComments(),this.options.enableAttachments&&this.options.enableNavigation&&this.createAttachments(),this.$el.find("> .spinner").remove(),this.options.refresh())},showActiveContainer:function(){var t=this.$el.find(".navigation li[data-container-name].active").data("container-name"),e=this.$el.find('[data-container="'+t+'"]');e.siblings("[data-container]").hide(),e.show()},createComments:function(){var e=this;this.$el.find("#comment-list").remove();var n=t("<ul/>",{id:"comment-list",class:"main"}),a=[],i=[];t(this.getComments()).each(function(t,e){null==e.parent?a.push(e):i.push(e)}),this.sortComments(a,this.currentSortKey),t(a).each(function(t,a){e.addComment(a,n)}),this.sortComments(i,"oldest"),t(i).each(function(t,a){e.addComment(a,n)}),this.$el.find('[data-container="comments"]').prepend(n)},createAttachments:function(){var e=this;this.$el.find("#attachment-list").remove();var n=t("<ul/>",{id:"attachment-list",class:"main"}),a=this.getAttachments();this.sortComments(a,"newest"),t(a).each(function(t,a){e.addAttachment(a,n)}),this.$el.find('[data-container="attachments"]').prepend(n)},addComment:function(t,e,n){e=e||this.$el.find("#comment-list");var a=this.createCommentElement(t);if(t.parent){var i=e.find('.comment[data-id="'+t.parent+'"]');this.reRenderCommentActionBar(t.parent);var o=i.parents(".comment").last();0==o.length&&(o=i);var s=o.find(".child-comments"),r=s.find(".commenting-field");r.length?r.before(a):s.append(a),this.updateToggleAllButton(o)}else n?e.prepend(a):e.append(a)},addAttachment:function(t,e){e=e||this.$el.find("#attachment-list");var n=this.createCommentElement(t);e.prepend(n)},removeComment:function(e){var n=this,a=this.commentsById[e],i=this.getChildComments(a.id);if(t(i).each(function(t,e){n.removeComment(e.id)}),a.parent){var o=this.getOutermostParent(a.parent),s=o.childs.indexOf(a.id);o.childs.splice(s,1)}delete this.commentsById[e];var r=this.$el.find('li.comment[data-id="'+e+'"]'),l=r.parents("li.comment").last();r.remove(),this.updateToggleAllButton(l)},preDeleteAttachment:function(e){var n=t(e.currentTarget).parents(".commenting-field").first();t(e.currentTarget).parents(".attachment").first().remove(),this.toggleSaveButton(n)},preSaveAttachments:function(e,n){var a=this;if(e.length){n||(n=this.$el.find(".commenting-field.main"));var i=n.find(".control-row .upload"),o=(n.hasClass("main"),n.find(".control-row .attachments")),s=t(e).map(function(t,e){return{mime_type:e.type,file:e}}),r=this.getAttachmentsFromCommentingField(n);s=s.filter(function(e,n){var a=!1;return t(r).each(function(t,e){n.file.name==e.file.name&&n.file.size==e.file.size&&(a=!0)}),!a}),n.hasClass("main")&&n.find(".textarea").trigger("click"),this.setButtonState(i,!1,!0),this.options.validateAttachments(s,function(e){e.length&&(t(e).each(function(t,e){var n=a.createAttachmentTagElement(e,!0);o.append(n)}),a.toggleSaveButton(n)),a.setButtonState(i,!0,!1)})}i.find("input").val("")},updateToggleAllButton:function(e){if(null!=this.options.maxRepliesVisible){var n=e.find(".child-comments"),a=n.find(".comment").not(".hidden"),i=n.find("li.toggle-all");if(a.removeClass("togglable-reply"),0===this.options.maxRepliesVisible)var o=a;else o=a.slice(0,-this.options.maxRepliesVisible);if(o.addClass("togglable-reply"),i.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)&&o.addClass("visible"),a.length>this.options.maxRepliesVisible){if(!i.length){i=t("<li/>",{class:"toggle-all highlight-font-bold"});var s=t("<span/>",{class:"text"}),r=t("<span/>",{class:"caret"});i.append(s).append(r),n.prepend(i)}this.setToggleAllButtonText(i,!1)}else i.remove()}},updateToggleAllButtons:function(){var e=this,n=this.$el.find("#comment-list");n.find(".comment").removeClass("visible"),n.children(".comment").each(function(n,a){e.updateToggleAllButton(t(a))})},sortComments:function(t,e){var n=this;"popularity"==e?t.sort(function(t,e){var a=t.childs.length,i=e.childs.length;if(n.options.enableUpvoting&&(a+=t.upvoteCount,i+=e.upvoteCount),i!=a)return i-a;var o=new Date(t.created).getTime();return new Date(e.created).getTime()-o}):t.sort(function(t,n){var a=new Date(t.created).getTime(),i=new Date(n.created).getTime();return"oldest"==e?a-i:i-a})},sortAndReArrangeComments:function(e){var n=this.$el.find("#comment-list"),a=this.getComments().filter(function(t){return!t.parent});this.sortComments(a,e),t(a).each(function(t,e){var a=n.find("> li.comment[data-id="+e.id+"]");n.append(a)})},showActiveSort:function(){var t=this.$el.find('.navigation li[data-sort-key="'+this.currentSortKey+'"]');this.$el.find(".navigation li").removeClass("active"),t.addClass("active");var e=this.$el.find(".navigation .title");if("attachments"!=this.currentSortKey)e.addClass("active"),e.find("header").html(t.first().html());else{var n=this.$el.find(".navigation ul.dropdown").children().first();e.find("header").html(n.html())}this.showActiveContainer()},forceResponsive:function(){this.$el.addClass("responsive")},closeDropdowns:function(){this.$el.find(".dropdown").hide()},preSavePastedAttachments:function(e){var n=e.originalEvent.clipboardData.files;if(n&&1==n.length){var a,i=t(e.target).parents(".commenting-field").first();i.length&&(a=i),this.preSaveAttachments(n,a),e.preventDefault()}},saveOnKeydown:function(e){if(13==e.keyCode){var n=e.metaKey||e.ctrlKey;if(this.options.postCommentOnEnter||n)t(e.currentTarget).siblings(".control-row").find(".save").trigger("click"),e.stopPropagation(),e.preventDefault()}},saveEditableContent:function(e){var n=t(e.currentTarget);n.data("before",n.html())},checkEditableContentForChange:function(e){var n=t(e.currentTarget);t(n[0].childNodes).each(function(){this.nodeType==Node.TEXT_NODE&&0==this.length&&this.removeNode&&this.removeNode()}),n.data("before")!=n.html()&&(n.data("before",n.html()),n.trigger("change"))},navigationElementClicked:function(e){var n=t(e.currentTarget).data().sortKey;"attachments"==n?this.createAttachments():this.sortAndReArrangeComments(n),this.currentSortKey=n,this.showActiveSort()},toggleNavigationDropdown:function(e){e.stopPropagation(),t(e.currentTarget).find("~ .dropdown").toggle()},showMainCommentingField:function(e){var n=t(e.currentTarget);n.siblings(".control-row").show(),n.parent().find(".close").show(),n.parent().find(".upload.inline-button").hide(),n.focus()},hideMainCommentingField:function(e){var n=t(e.currentTarget),a=this.$el.find(".commenting-field.main"),i=a.find(".textarea"),o=a.find(".control-row");this.clearTextarea(i),a.find(".attachments").empty(),this.toggleSaveButton(a),this.adjustTextareaHeight(i,!1),o.hide(),n.hide(),i.parent().find(".upload.inline-button").show(),i.blur()},increaseTextareaHeight:function(e){var n=t(e.currentTarget);this.adjustTextareaHeight(n,!0)},textareaContentChanged:function(e){var n=t(e.currentTarget);if(!n.find(".reply-to.tag").length)if(n.attr("data-comment")){var a=n.parents("li.comment");if(a.length>1){var i=a.last().data("id");n.attr("data-parent",i)}}else{i=n.parents("li.comment").last().data("id");n.attr("data-parent",i)}var o=n.parents(".commenting-field").first();n[0].scrollHeight>n.outerHeight()?o.addClass("commenting-field-scrollable"):o.removeClass("commenting-field-scrollable"),this.toggleSaveButton(o)},toggleSaveButton:function(t){var e,n=t.find(".textarea"),a=n.siblings(".control-row").find(".save"),i=this.getTextareaContent(n,!0),o=this.getAttachmentsFromCommentingField(t);if(commentModel=this.commentsById[n.attr("data-comment")]){var s,r=i!=commentModel.content;commentModel.parent&&(s=commentModel.parent.toString());var l=n.attr("data-parent")!=s,c=!1;if(this.options.enableAttachments){var d=commentModel.attachments.map(function(t){return t.id}),p=o.map(function(t){return t.id});c=!this.areArraysEqual(d,p)}e=r||l||c}else e=Boolean(i.length)||Boolean(o.length);a.toggleClass("enabled",e)},removeCommentingField:function(e){var n=t(e.currentTarget);n.siblings(".textarea").attr("data-comment")&&n.parents("li.comment").first().removeClass("edit"),n.parents(".commenting-field").first().remove()},postComment:function(e){var n=this,a=t(e.currentTarget),i=a.parents(".commenting-field").first();this.setButtonState(a,!1,!0);var o=this.createCommentJSON(i);o=this.applyExternalMappings(o);this.options.postComment(o,function(t){n.createComment(t),i.find(".close").trigger("click"),n.setButtonState(a,!1,!1)},function(){n.setButtonState(a,!0,!1)})},createComment:function(t){var e=this.createCommentModel(t);this.addCommentToDataModel(e);var n=this.$el.find("#comment-list"),a="newest"==this.currentSortKey;this.addComment(e,n,a),"attachments"==this.currentSortKey&&e.hasAttachments()&&this.addAttachment(e)},putComment:function(e){var n=this,a=t(e.currentTarget),i=a.parents(".commenting-field").first(),o=i.find(".textarea");this.setButtonState(a,!1,!0);var s=t.extend({},this.commentsById[o.attr("data-comment")]);t.extend(s,{parent:o.attr("data-parent")||null,content:this.getTextareaContent(o),pings:this.getPings(o),modified:(new Date).getTime(),attachments:this.getAttachmentsFromCommentingField(i)}),s=this.applyExternalMappings(s);this.options.putComment(s,function(t){var e=n.createCommentModel(t);delete e.childs,n.updateCommentModel(e),i.find(".close").trigger("click"),n.reRenderComment(e.id),n.setButtonState(a,!1,!1)},function(){n.setButtonState(a,!0,!1)})},deleteComment:function(e){var n=this,a=t(e.currentTarget),i=a.parents(".comment").first(),o=t.extend({},this.commentsById[i.attr("data-id")]),s=o.id,r=o.parent;this.setButtonState(a,!1,!0),o=this.applyExternalMappings(o);this.options.deleteComment(o,function(){n.removeComment(s),r&&n.reRenderCommentActionBar(r),n.setButtonState(a,!1,!1)},function(){n.setButtonState(a,!0,!1)})},hashtagClicked:function(e){var n=t(e.currentTarget).attr("data-value");this.options.hashtagClicked(n)},pingClicked:function(e){var n=t(e.currentTarget).attr("data-value");this.options.pingClicked(n)},fileInputChanged:function(e,n){n=e.currentTarget.files;var a=t(e.currentTarget).parents(".commenting-field").first();this.preSaveAttachments(n,a)},upvoteComment:function(e){var n,a=this,i=t(e.currentTarget).parents("li.comment").first().data().model,o=i.upvoteCount;n=i.userHasUpvoted?o-1:o+1,i.userHasUpvoted=!i.userHasUpvoted,i.upvoteCount=n,this.reRenderUpvotes(i.id);var s=t.extend({},i);s=this.applyExternalMappings(s);this.options.upvoteComment(s,function(t){var e=a.createCommentModel(t);a.updateCommentModel(e),a.reRenderUpvotes(e.id)},function(){i.userHasUpvoted=!i.userHasUpvoted,i.upvoteCount=o,a.reRenderUpvotes(i.id)})},toggleReplies:function(e){var n=t(e.currentTarget);n.siblings(".togglable-reply").toggleClass("visible"),this.setToggleAllButtonText(n,!0)},replyButtonClicked:function(e){var n=t(e.currentTarget),a=n.parents("li.comment").last(),i=n.parents(".comment").first().data().id,o=a.find(".child-comments > .commenting-field");if(o.length&&o.remove(),o.find(".textarea").attr("data-parent")!=i){o=this.createCommentingFieldElement(i),a.find(".child-comments").append(o);var s=o.find(".textarea");this.moveCursorToEnd(s),this.ensureElementStaysVisible(o)}},editButtonClicked:function(e){var n=t(e.currentTarget).parents("li.comment").first(),a=n.data().model;n.addClass("edit");var i=this.createCommentingFieldElement(a.parent,a.id);n.find(".comment-wrapper").first().append(i);var o=i.find(".textarea");o.attr("data-comment",a.id),o.append(this.getFormattedCommentContent(a,!0)),this.moveCursorToEnd(o),this.ensureElementStaysVisible(i)},showDroppableOverlay:function(t){this.options.enableAttachments&&(this.$el.find(".droppable-overlay").css("top",this.$el[0].scrollTop),this.$el.find(".droppable-overlay").show(),this.$el.addClass("drag-ongoing"))},handleDragEnter:function(e){var n=t(e.currentTarget).data("dnd-count")||0;n++,t(e.currentTarget).data("dnd-count",n),t(e.currentTarget).addClass("drag-over")},handleDragLeave:function(e,n){var a=t(e.currentTarget).data("dnd-count");a--,t(e.currentTarget).data("dnd-count",a),0==a&&(t(e.currentTarget).removeClass("drag-over"),n&&n())},handleDragLeaveForOverlay:function(t){var e=this;this.handleDragLeave(t,function(){e.hideDroppableOverlay()})},handleDragLeaveForDroppable:function(t){this.handleDragLeave(t)},handleDragOverForOverlay:function(t){t.stopPropagation(),t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy"},hideDroppableOverlay:function(){this.$el.find(".droppable-overlay").hide(),this.$el.removeClass("drag-ongoing")},handleDrop:function(e){e.preventDefault(),t(e.target).trigger("dragleave"),this.hideDroppableOverlay(),this.preSaveAttachments(e.originalEvent.dataTransfer.files)},stopPropagation:function(t){t.stopPropagation()},createHTML:function(){var e=this.createMainCommentingFieldElement();this.$el.append(e),e.find(".control-row").hide(),e.find(".close").hide(),this.options.enableNavigation&&(this.$el.append(this.createNavigationElement()),this.showActiveSort());var n=this.createSpinner();this.$el.append(n);var a=t("<div/>",{class:"data-container","data-container":"comments"});this.$el.append(a);var i=t("<div/>",{class:"no-comments no-data",text:this.options.textFormatter(this.options.noCommentsText)}),o=t("<i/>",{class:"fa fa-comments fa-2x"});if(this.options.noCommentsIconURL.length&&(o.css("background-image",'url("'+this.options.noCommentsIconURL+'")'),o.addClass("image")),i.prepend(t("<br/>")).prepend(o),a.append(i),this.options.enableAttachments){var s=t("<div/>",{class:"data-container","data-container":"attachments"});this.$el.append(s);var r=t("<div/>",{class:"no-attachments no-data",text:this.options.textFormatter(this.options.noAttachmentsText)}),l=t("<i/>",{class:"fa fa-paperclip fa-2x"});this.options.attachmentIconURL.length&&(l.css("background-image",'url("'+this.options.attachmentIconURL+'")'),l.addClass("image")),r.prepend(t("<br/>")).prepend(l),s.append(r);var c=t("<div/>",{class:"droppable-overlay"}),d=t("<div/>",{class:"droppable-container"}),p=t("<div/>",{class:"droppable"}),m=t("<i/>",{class:"fa fa-paperclip fa-4x"});this.options.uploadIconURL.length&&(m.css("background-image",'url("'+this.options.uploadIconURL+'")'),m.addClass("image"));var h=t("<div/>",{text:this.options.textFormatter(this.options.attachmentDropText)});p.append(m),p.append(h),c.html(d.html(p)).hide(),this.$el.append(c)}},createProfilePictureElement:function(e,n){if(e)var a=t("<div/>").css({"background-image":"url("+e+")"});else a=t("<i/>",{class:"fa fa-user"});return a.addClass("profile-picture"),a.attr("data-user-id",n),this.options.roundProfilePictures&&a.addClass("round"),a},createMainCommentingFieldElement:function(){return this.createCommentingFieldElement(void 0,void 0,!0)},createCommentingFieldElement:function(e,n,a){var i,o,s,r=this,l=t("<div/>",{class:"commenting-field"});a&&l.addClass("main"),n?(i=this.commentsById[n].profilePictureURL,o=this.commentsById[n].creator,s=this.commentsById[n].attachments):(i=this.options.profilePictureURL,o=this.options.creator,s=[]);var c=this.createProfilePictureElement(i,o),d=t("<div/>",{class:"textarea-wrapper"}),p=t("<div/>",{class:"control-row"}),m=t("<div/>",{class:"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:!0});this.adjustTextareaHeight(m,!1);var h=this.createCloseButton();h.addClass("inline-button");var u=n?"update":"send",g=n?this.options.textFormatter(this.options.saveText):this.options.textFormatter(this.options.sendText),f=t("<span/>",{class:u+" save highlight-background",text:g});if(f.data("original-content",g),p.append(f),n&&this.isAllowedToDelete(n)){var v=this.options.textFormatter(this.options.deleteText),C=t("<span/>",{class:"delete enabled",text:v}).css("background-color",this.options.deleteButtonColor);C.data("original-content",v),p.append(C)}if(this.options.enableAttachments){var b=t("<span/>",{class:"enabled upload"}),y=t("<i/>",{class:"fa fa-paperclip"}),x=t("<input/>",{type:"file",multiple:"multiple","data-role":"none"});this.options.uploadIconURL.length&&(y.css("background-image",'url("'+this.options.uploadIconURL+'")'),y.addClass("image")),b.append(y).append(x);var w=b.clone();w.data("original-content",w.children()),p.append(w),a&&d.append(b.clone().addClass("inline-button"));var T=t("<div/>",{class:"attachments"});t(s).each(function(t,e){var n=r.createAttachmentTagElement(e,!0);T.append(n)}),p.append(T)}if(d.append(h).append(m).append(p),l.append(c).append(d),e){m.attr("data-parent",e);var k=this.commentsById[e];if(k.parent){m.html("&nbsp;");var R="@"+k.fullname,A=this.createTagElement(R,"reply-to",k.creator,{"data-user-id":k.creator});m.prepend(A)}}return this.options.enablePinging&&(m.textcomplete([{match:/(^|\s)@([^@]*)$/i,index:2,search:function(t,e){t=r.normalizeSpaces(t);r.options.searchUsers(t,e,function(){e([])})},template:function(e){var n=t("<div/>"),a=r.createProfilePictureElement(e.profile_picture_url),i=t("<div/>",{class:"details"}),o=t("<div/>",{class:"name"}).html(e.fullname),s=t("<div/>",{class:"email"}).html(e.email);return e.email?i.append(o).append(s):(i.addClass("no-email"),i.append(o)),n.append(a).append(i),n.html()},replace:function(t){return" "+r.createTagElement("@"+t.fullname,"ping",t.id,{"data-user-id":t.id})[0].outerHTML+" "}}],{appendTo:".jquery-comments",dropdownClassName:"dropdown autocomplete",maxCount:5,rightEdgeOffset:0,debounce:250}),t.fn.textcomplete.Dropdown.prototype.render=function(e){var n=this._buildContents(e),a=t.map(e,function(t){return t.value});if(e.length){var i=e[0].strategy;i.id?this.$el.attr("data-strategy",i.id):this.$el.removeAttr("data-strategy"),this._renderHeader(a),this._renderFooter(a),n&&(this._renderContents(n),this._fitToBottom(),this._fitToRight(),this._activateIndexedItem()),this._setScroll()}else this.noResultsMessage?this._renderNoResultsMessage(a):this.shown&&this.deactivate();var o=parseInt(this.$el.css("top"))+r.options.scrollContainer.scrollTop();this.$el.css("top",o);var s=this.$el.css("left");this.$el.css("left",0);var l=r.$el.width()-this.$el.outerWidth(),c=Math.min(l,parseInt(s));this.$el.css("left",c)},t.fn.textcomplete.ContentEditable.prototype._skipSearch=function(t){switch(t.keyCode){case 9:case 13:case 16:case 17:case 33:case 34:case 40:case 38:case 27:return!0}if(t.ctrlKey)switch(t.keyCode){case 78:case 80:return!0}}),l},createNavigationElement:function(){var e=t("<ul/>",{class:"navigation"}),n=t("<div/>",{class:"navigation-wrapper"});e.append(n);var a=t("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest","data-container-name":"comments"}),i=t("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest","data-container-name":"comments"}),o=t("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity","data-container-name":"comments"}),s=t("<li/>",{text:this.options.textFormatter(this.options.attachmentsText),"data-sort-key":"attachments","data-container-name":"attachments"}),r=t("<i/>",{class:"fa fa-paperclip"});this.options.attachmentIconURL.length&&(r.css("background-image",'url("'+this.options.attachmentIconURL+'")'),r.addClass("image")),s.prepend(r);var l=t("<div/>",{class:"navigation-wrapper responsive"}),c=t("<ul/>",{class:"dropdown"}),d=t("<li/>",{class:"title"}),p=t("<header/>");return d.append(p),l.append(d),l.append(c),e.append(l),n.append(a).append(i),c.append(a.clone()).append(i.clone()),(this.options.enableReplying||this.options.enableUpvoting)&&(n.append(o),c.append(o.clone())),this.options.enableAttachments&&(n.append(s),l.append(s.clone())),this.options.forceResponsive&&this.forceResponsive(),e},createSpinner:function(e){var n=t("<div/>",{class:"spinner"});e&&n.addClass("inline");var a=t("<i/>",{class:"fa fa-spinner fa-spin"});return this.options.spinnerIconURL.length&&(a.css("background-image",'url("'+this.options.spinnerIconURL+'")'),a.addClass("image")),n.html(a),n},createCloseButton:function(e){var n=t("<span/>",{class:e||"close"}),a=t("<i/>",{class:"fa fa-times"});return this.options.closeIconURL.length&&(a.css("background-image",'url("'+this.options.closeIconURL+'")'),a.addClass("image")),n.html(a),n},createCommentElement:function(e){var n=t("<li/>",{"data-id":e.id,class:"comment"}).data("model",e);e.createdByCurrentUser&&n.addClass("by-current-user"),e.createdByAdmin&&n.addClass("by-admin");var a=t("<ul/>",{class:"child-comments"}),i=this.createCommentWrapperElement(e);return n.append(i),null==e.parent&&n.append(a),n},createCommentWrapperElement:function(e){var n=this,a=t("<div/>",{class:"comment-wrapper"}),i=this.createProfilePictureElement(e.profilePictureURL,e.creator),o=t("<time/>",{text:this.options.timeFormatter(e.created),"data-original":e.created}),s=t("<div/>",{class:"comment-header"}),r=t("<span/>",{class:"name","data-user-id":e.creator,text:e.createdByCurrentUser?this.options.textFormatter(this.options.youText):e.fullname});if(s.append(r),e.createdByAdmin&&r.addClass("highlight-font-bold"),e.parent){var l=this.commentsById[e.parent];if(l.parent){var c=t("<span/>",{class:"reply-to",text:l.fullname,"data-user-id":l.creator}),d=t("<i/>",{class:"fa fa-share"});this.options.replyIconURL.length&&(d.css("background-image",'url("'+this.options.replyIconURL+'")'),d.addClass("image")),c.prepend(d),s.append(c)}}if(e.isNew){var p=t("<span/>",{class:"new highlight-background",text:this.options.textFormatter(this.options.newText)});s.append(p)}var m=t("<div/>",{class:"wrapper"}),h=t("<div/>",{class:"content"});if(h.html(this.getFormattedCommentContent(e)),e.modified&&e.modified!=e.created){var u=this.options.timeFormatter(e.modified),g=t("<time/>",{class:"edited",text:this.options.textFormatter(this.options.editedText)+" "+u,"data-original":e.modified});h.append(g)}var f=t("<div/>",{class:"attachments"}),v=t("<div/>",{class:"previews"}),C=t("<div/>",{class:"tags"});f.append(v).append(C),this.options.enableAttachments&&e.hasAttachments()&&t(e.attachments).each(function(e,a){var i=void 0;if(a.mime_type){var o=a.mime_type.split("/");2==o.length&&(o[1],i=o[0])}if("image"==i||"video"==i){var s=t("<div/>"),r=t("<a/>",{class:"preview",href:a.file,target:"_blank"});if(s.html(r),"image"==i){var l=t("<img/>",{src:a.file});r.html(l)}else{var c=t("<video/>",{src:a.file,type:a.mime_type,controls:"controls"});r.html(c)}v.append(s)}var d=n.createAttachmentTagElement(a,!1);C.append(d)});var b=t("<span/>",{class:"actions"}),y=t("<span/>",{class:"separator",text:"Â·"}),x=t("<button/>",{class:"action reply",type:"button",text:this.options.textFormatter(this.options.replyText)}),w=t("<i/>",{class:"fa fa-thumbs-up"});this.options.upvoteIconURL.length&&(w.css("background-image",'url("'+this.options.upvoteIconURL+'")'),w.addClass("image"));var T=this.createUpvoteElement(e);if(this.options.enableReplying&&b.append(x),this.options.enableUpvoting&&b.append(T),e.createdByCurrentUser||this.options.currentUserIsAdmin){var k=t("<button/>",{class:"action edit",text:this.options.textFormatter(this.options.editText)});b.append(k)}return b.children().each(function(e,n){t(n).is(":last-child")||t(n).after(y.clone())}),m.append(h),m.append(f),m.append(b),a.append(i).append(o).append(s).append(m),a},createUpvoteElement:function(e){var n=t("<i/>",{class:"fa fa-thumbs-up"});return this.options.upvoteIconURL.length&&(n.css("background-image",'url("'+this.options.upvoteIconURL+'")'),n.addClass("image")),t("<button/>",{class:"action upvote"+(e.userHasUpvoted?" highlight-font":"")}).append(t("<span/>",{text:e.upvoteCount,class:"upvote-count"})).append(n)},createTagElement:function(e,n,a,i){var o=t("<input/>",{class:"tag",type:"button","data-role":"none"});return n&&o.addClass(n),o.val(e),o.attr("data-value",a),i&&o.attr(i),o},createAttachmentTagElement:function(e,n){var a=t("<a/>",{class:"tag attachment",target:"_blank"});n||a.attr("href",e.file),a.data({id:e.id,mime_type:e.mime_type,file:e.file});var i="";if(e.file instanceof File)i=e.file.name;else{var o=e.file.split("/");i=(i=o[o.length-1]).split("?")[0],i=decodeURIComponent(i)}var s=t("<i/>",{class:"fa fa-paperclip"});if(this.options.attachmentIconURL.length&&(s.css("background-image",'url("'+this.options.attachmentIconURL+'")'),s.addClass("image")),a.append(s,i),n){a.addClass("deletable");var r=this.createCloseButton("delete");a.append(r)}return a},reRenderComment:function(e){var n=this.commentsById[e],a=this.$el.find('li.comment[data-id="'+n.id+'"]'),i=this;a.each(function(e,a){var o=i.createCommentWrapperElement(n);t(a).find(".comment-wrapper").first().replaceWith(o)})},reRenderCommentActionBar:function(e){var n=this.commentsById[e],a=this.$el.find('li.comment[data-id="'+n.id+'"]'),i=this;a.each(function(e,a){var o=i.createCommentWrapperElement(n);t(a).find(".actions").first().replaceWith(o.find(".actions"))})},reRenderUpvotes:function(e){var n=this.commentsById[e],a=this.$el.find('li.comment[data-id="'+n.id+'"]'),i=this;a.each(function(e,a){var o=i.createUpvoteElement(n);t(a).find(".upvote").first().replaceWith(o)})},createCssDeclarations:function(){t("head style.jquery-comments-css").remove(),this.createCss(".jquery-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments ul.navigation ul.dropdown li.active {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-background {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-font {color: "+this.options.highlightColor+" !important;}"),this.createCss(".jquery-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(e){var n=t("<style/>",{type:"text/css",class:"jquery-comments-css",text:e});t("head").append(n)},getComments:function(){var t=this;return Object.keys(this.commentsById).map(function(e){return t.commentsById[e]})},getChildComments:function(t){return this.getComments().filter(function(e){return e.parent==t})},getAttachments:function(){return this.getComments().filter(function(t){return t.hasAttachments()})},getOutermostParent:function(t){var e=t;do{var n=this.commentsById[e];e=n.parent}while(null!=n.parent);return n},createCommentJSON:function(t){var e=t.find(".textarea"),n=(new Date).toISOString();return{id:"c"+(this.getComments().length+1),parent:e.attr("data-parent")||null,created:n,modified:n,content:this.getTextareaContent(e),pings:this.getPings(e),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:!0,upvoteCount:0,userHasUpvoted:!1,attachments:this.getAttachmentsFromCommentingField(t)}},isAllowedToDelete:function(e){if(this.options.enableDeleting){var n=!0;return this.options.enableDeletingCommentWithReplies||t(this.getComments()).each(function(t,a){a.parent==e&&(n=!1)}),n}return!1},setToggleAllButtonText:function(t,e){var n=this,a=t.find("span.text"),i=t.find(".caret"),o=function(){var e=n.options.textFormatter(n.options.viewAllRepliesText),i=t.siblings(".comment").not(".hidden").length;e=e.replace("__replyCount__",i),a.text(e)},s=this.options.textFormatter(this.options.hideRepliesText);e?(a.text()==s?o():a.text(s),i.toggleClass("up")):a.text()!=s&&o()},setButtonState:function(t,e,n){t.toggleClass("enabled",e),n?t.html(this.createSpinner(!0)):t.html(t.data("original-content"))},adjustTextareaHeight:function(e,n){e=t(e);var a,i=1==n?this.options.textareaRowsOnFocus:this.options.textareaRows;do{a=void 0,a=2.2+1.45*(i-1),e.css("height",a+"em"),i++;var o=e[0].scrollHeight>e.outerHeight(),s=0!=this.options.textareaMaxRows&&i>this.options.textareaMaxRows}while(o&&!s)},clearTextarea:function(t){t.empty().trigger("input")},getTextareaContent:function(e,n){var a=e.clone();a.find(".reply-to.tag").remove(),a.find(".tag.hashtag").replaceWith(function(){return n?t(this).val():"#"+t(this).attr("data-value")}),a.find(".tag.ping").replaceWith(function(){return n?t(this).val():"@"+t(this).attr("data-value")});var i=t("<pre/>").html(a.html());i.find("div, p, br").replaceWith(function(){return"\n"+this.innerHTML});var o=i.text().replace(/^\s+/g,"");return o=this.normalizeSpaces(o)},getFormattedCommentContent:function(t,e){var n=this.escape(t.content);return n=this.linkify(n),n=this.highlightTags(t,n),e&&(n=n.replace(/(?:\n)/g,"<br>")),n},getPings:function(e){var n={};return e.find(".ping").each(function(e,a){var i=parseInt(t(a).attr("data-value")),o=t(a).val();n[i]=o.slice(1)}),n},getAttachmentsFromCommentingField:function(e){return e.find(".attachments .attachment").map(function(){return t(this).data()}).toArray()},moveCursorToEnd:function(e){if(e=t(e)[0],t(e).trigger("input"),t(e).scrollTop(e.scrollHeight),void 0!==window.getSelection&&void 0!==document.createRange){var n=document.createRange();n.selectNodeContents(e),n.collapse(!1);var a=window.getSelection();a.removeAllRanges(),a.addRange(n)}else if(void 0!==document.body.createTextRange){var i=document.body.createTextRange();i.moveToElementText(e),i.collapse(!1),i.select()}e.focus()},ensureElementStaysVisible:function(t){var e=t.position().top,n=t.position().top+t.outerHeight()-this.options.scrollContainer.outerHeight();this.options.scrollContainer.scrollTop()>e?this.options.scrollContainer.scrollTop(e):this.options.scrollContainer.scrollTop()<n&&this.options.scrollContainer.scrollTop(n)},escape:function(e){return t("<pre/>").text(this.normalizeSpaces(e)).html()},normalizeSpaces:function(t){return t.replace(new RegExp("Â ","g")," ")},after:function(t,e){var n=this;return function(){if(0==--t)return e.apply(n,arguments)}},highlightTags:function(t,e){return this.options.enableHashtags&&(e=this.highlightHashtags(t,e)),this.options.enablePinging&&(e=this.highlightPings(t,e)),e},highlightHashtags:function(t,e){var n=this;if(-1!=e.indexOf("#")){e=e.replace(/(^|\s)#([a-z\u00C0-\u00FF\d-_]+)/gim,function(t,e,a){return e+(i=a,(i=n.createTagElement("#"+i,"hashtag",i))[0].outerHTML);var i})}return e},highlightPings:function(e,n){var a=this;if(-1!=n.indexOf("@")){t(Object.keys(e.pings)).each(function(t,i){var o="@"+e.pings[i];n=n.replace(new RegExp(o,"g"),function(t,e){return a.createTagElement(t,"ping",e,{"data-user-id":e})[0].outerHTML}(o,i))})}return n},linkify:function(t){var e,n,a,i;if(n=/(\b(https?|ftp|file):\/\/[-A-ZÃÃÃ0-9+&@#\/%?=~_|!:,.;]*[-A-ZÃÃÃ0-9+&@#\/%=~_|])/gim,a=/(^|[^\/f])(www\.[-A-ZÃÃÃ0-9+&@#\/%?=~_|!:,.;]*[-A-ZÃÃÃ0-9+&@#\/%=~_|])/gim,i=/(([A-ZÃÃÃ0-9\-\_\.])+@[A-ZÃÃÃ\_]+?(\.[A-ZÃÃÃ]{2,6})+)/gim,e=(e=(e=t.replace(n,'<a href="$1" target="_blank">$1</a>')).replace(a,'$1<a href="https://$2" target="_blank">$2</a>')).replace(i,'<a href="mailto:$1" target="_blank">$1</a>'),(t.match(/<a href/g)||[]).length>0){for(var o=t.split(/(<\/a>)/g),s=0;s<o.length;s++)null==o[s].match(/<a href/g)&&(o[s]=o[s].replace(n,'<a href="$1" target="_blank">$1</a>').replace(a,'$1<a href="https://$2" target="_blank">$2</a>').replace(i,'<a href="mailto:$1" target="_blank">$1</a>'));return o.join("")}return e},waitUntil:function(t,e){var n=this;t()?e():setTimeout(function(){n.waitUntil(t,e)},100)},areArraysEqual:function(t,e){if(t.length!=e.length)return!1;t.sort(),e.sort();for(var n=0;n<t.length;n++)if(t[n]!=e[n])return!1;return!0},applyInternalMappings:function(t){var e={},n=this.options.fieldMappings;for(var a in n)n.hasOwnProperty(a)&&(e[n[a]]=a);return this.applyMappings(e,t)},applyExternalMappings:function(t){var e=this.options.fieldMappings;return this.applyMappings(e,t)},applyMappings:function(t,e){var n={};for(var a in e){if(a in t)n[t[a]]=e[a]}return n}};t.fn.comments=function(n){return this.each(function(){var a=Object.create(e);t.data(this,"comments",a),a.init(n||{},this)})}});