/*!     jquery-comments.js 1.4.0
 *
 *     (c) 2017 Joona Tykkyläinen, Viima Solutions Oy
 *     jquery-comments may be freely distributed under the MIT license.
 *     For all details and documentation:
 *     http://viima.github.io/jquery-comments/
 */
!function(n){"function"==typeof define&&define.amd?define(["jquery"],n):"object"==typeof module&&module.exports?module.exports=function(e,t){return void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(e)),n(t),t}:n(jQuery)}(function(w){var n={$el:null,commentsById:{},dataFetched:!1,currentSortKey:"",options:{},events:{click:"closeDropdowns","keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li[data-sort-key]":"navigationElementClicked","click .navigation li.title":"toggleNavigationDropdown","click .commenting-field.main .textarea":"showMainCommentingField","click .commenting-field.main .close":"hideMainCommentingField","click .commenting-field .textarea":"increaseTextareaHeight","change .commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .commenting-field:not(.main) .close":"removeCommentingField","click .commenting-field .attachment-inline-wrapper .delete":"removeImage","click .commenting-field .send.enabled":"postComment","click .commenting-field .update.enabled":"putComment","click .commenting-field .delete.enabled":"deleteComment",'change .commenting-field .upload.enabled input[type="file"]':"fileInputChanged","click li.comment button.upvote":"upvoteComment","click li.comment button.delete.enabled":"deleteComment","click li.comment .hashtag":"hashtagClicked","click li.comment .ping":"pingClicked","click li.comment ul.child-comments .toggle-all":"toggleReplies","click li.comment button.reply":"replyButtonClicked","click li.comment button.edit":"editButtonClicked",dragenter:"showDroppableOverlay","dragenter .droppable-overlay":"handleDragEnter","dragleave .droppable-overlay":"handleDragLeaveForOverlay","dragenter .droppable-overlay .droppable":"handleDragEnter","dragleave .droppable-overlay .droppable":"handleDragLeaveForDroppable","dragover .droppable-overlay":"handleDragOverForOverlay","drop .droppable-overlay":"handleDrop","click .dropdown.autocomplete":"stopPropagation","mousedown .dropdown.autocomplete":"stopPropagation","touchstart .dropdown.autocomplete":"stopPropagation"},getDefaultOptions:function(){return{profilePictureURL:"",currentUserIsAdmin:!1,currentUserId:null,spinnerIconURL:"",upvoteIconURL:"",replyIconURL:"",uploadIconURL:"",attachmentIconURL:"",fileIconURL:"",noCommentsIconURL:"",textareaPlaceholderText:"Add a comment",newestText:"Newest",oldestText:"Oldest",popularText:"Popular",attachmentsText:"Attachments",sendText:"Send",replyText:"Reply",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",newText:"New",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",noAttachmentsText:"No attachments",attachmentDropText:"Drop files here",textFormatter:function(e){return e},enableReplying:!0,enableEditing:!0,enableUpvoting:!0,enableDeleting:!0,enableAttachments:!1,enableHashtags:!1,enablePinging:!1,enableDeletingCommentWithReplies:!1,enableNavigation:!0,postCommentOnEnter:!1,forceResponsive:!1,readOnly:!1,defaultNavigationSortKey:"newest",includeAttachmentInPost:!1,highlightColor:"#2793e6",deleteButtonColor:"#C9302C",scrollContainer:this.$el,roundProfilePictures:!1,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",file:"file",fileURL:"file_url",fileMimeType:"file_mime_type",pings:"pings",creator:"creator",fullname:"fullname",profileURL:"profile_url",profilePictureURL:"profile_picture_url",isNew:"is_new",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},searchUsers:function(e,t,n){t([])},getComments:function(e,t){e([])},postComment:function(e,t,n){t(e)},putComment:function(e,t,n){t(e)},deleteComment:function(e,t,n){t()},upvoteComment:function(e,t,n){t(e)},hashtagClicked:function(e){},pingClicked:function(e){},uploadAttachments:function(e,t,n){t(e)},refresh:function(){},timeFormatter:function(e){return new Date(e).toLocaleDateString()}}},init:function(e,t){var n;this.$el=w(t),this.$el.addClass("jquery-comments"),this.undelegateEvents(),this.delegateEvents(),n=navigator.userAgent||navigator.vendor||window.opera,(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(n)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(n.substr(0,4)),w.browser.mobile&&this.$el.addClass("mobile"),this.options=w.extend(!0,{},this.getDefaultOptions(),e),this.options.readOnly&&this.$el.addClass("read-only"),this.currentSortKey=this.options.defaultNavigationSortKey,this.createCssDeclarations(),this.fetchDataAndRender()},delegateEvents:function(){this.bindEvents(!1)},undelegateEvents:function(){this.bindEvents(!0)},bindEvents:function(e){var t=e?"off":"on";for(var n in this.events){var a=n.split(" ")[0],i=n.split(" ").slice(1).join(" "),o=this.events[n].split(" ");for(var s in o)if(o.hasOwnProperty(s)){var r=this[o[s]];r=w.proxy(r,this),""==i?this.$el[t](a,r):this.$el[t](a,i,r)}}},fetchDataAndRender:function(){var n=this;this.commentsById={},this.$el.empty(),this.createHTML(),this.options.getComments(function(e){var t=e.map(function(e){return n.createCommentModel(e)});n.sortComments(t,"oldest"),w(t).each(function(e,t){n.addCommentToDataModel(t)}),n.dataFetched=!0,n.render()})},fetchNext:function(){var n=this,t=this.createSpinner();this.$el.find("ul#comment-list").append(t);this.options.getComments(function(e){w(e).each(function(e,t){n.createComment(t)}),t.remove()},function(){t.remove()})},createCommentModel:function(e){var t=this.applyInternalMappings(e);return t.childs=[],t},addCommentToDataModel:function(e){e.id in this.commentsById||(this.commentsById[e.id]=e).parent&&this.getOutermostParent(e.parent).childs.push(e.id)},updateCommentModel:function(e){w.extend(this.commentsById[e.id],e)},render:function(){this.dataFetched&&(this.showActiveContainer(),this.createComments(),this.options.enableAttachments&&this.createAttachments(),this.$el.find("> .spinner").remove(),this.options.refresh())},showActiveContainer:function(){var e=this.$el.find(".navigation li[data-container-name].active").data("container-name"),t=this.$el.find('[data-container="'+e+'"]');t.siblings("[data-container]").hide(),t.show()},createComments:function(){var n=this;this.$el.find("#comment-list").remove();var a=w("<ul/>",{id:"comment-list",class:"main"}),i=[],o=[];w(this.getComments()).each(function(e,t){null==t.parent?i.push(t):o.push(t)}),this.sortComments(i,this.currentSortKey),i.reverse(),w(i).each(function(e,t){n.addComment(t,a)}),this.sortComments(o,"oldest"),w(o).each(function(e,t){n.addComment(t,a)}),this.$el.find('[data-container="comments"]').prepend(a)},createAttachments:function(){var n=this;this.$el.find("#attachment-list").remove();var a=w("<ul/>",{id:"attachment-list",class:"main"}),e=this.getAttachments();this.sortComments(e,"newest"),e.reverse(),w(e).each(function(e,t){n.addAttachment(t,a)}),this.$el.find('[data-container="attachments"]').prepend(a)},addComment:function(e,t){t=t||this.$el.find("#comment-list");var n=this.createCommentElement(e);if(e.parent){var a=t.find('.comment[data-id="'+e.parent+'"]');this.reRenderCommentActionBar(e.parent);var i=a.parents(".comment").last();0==i.length&&(i=a);var o=i.find(".child-comments"),s=o.find(".commenting-field");s.length?s.before(n):o.append(n),this.updateToggleAllButton(i)}else t.prepend(n)},addAttachment:function(e,t){t=t||this.$el.find("#attachment-list");var n=this.createCommentElement(e);t.prepend(n)},removeComment:function(e){var n=this,t=this.commentsById[e],a=this.getChildComments(t.id);if(w(a).each(function(e,t){n.removeComment(t.id)}),t.parent){var i=this.getOutermostParent(t.parent),o=i.childs.indexOf(t.id);i.childs.splice(o,1)}delete this.commentsById[e];var s=this.$el.find('li.comment[data-id="'+e+'"]'),r=s.parents("li.comment").last();s.remove(),this.updateToggleAllButton(r)},uploadAttachments:function(e,i){var o=this,t=(i=i||this.$el.find(".commenting-field.main")).find(".upload"),n=i.find(".send"),a=!i.hasClass("main"),s=e.length;if(s){var r=i.find(".textarea");t.removeClass("enabled");var l=this.createSpinner(),c=this.createSpinner();this.$el.find("ul#attachment-list").prepend(l),a?i.before(c):this.$el.find("ul#comment-list").prepend(c);var d=[];w(e).each(function(e,t){var n=o.createCommentJSON(r);n.id+="-"+e,n.content="",n.file=t,n.fileURL="C:/fakepath/"+t.name,n.fileMimeType=t.type,n=o.applyExternalMappings(n),d.push(n)}),o.options.uploadAttachments(d,function(e){1==o.options.includeAttachmentInPost?(w(e).each(function(e,t){var n=o.createCommentModel(t),a=o.createAttachment(n);i.append(a)}),n.addClass("enabled")):(w(e).each(function(e,t){var n=o.createCommentModel(t);o.addCommentToDataModel(n),o.addComment(n),o.addAttachment(n)}),e.length==s&&0==o.getTextareaContent(r).length&&1!=o.options.includeAttachmentInPost&&i.find(".close").trigger("click"),t.addClass("enabled")),c.remove(),l.remove()},function(){t.addClass("enabled"),c.remove(),l.remove()})}t.find("input").val("")},updateToggleAllButton:function(e){if(null!=this.options.maxRepliesVisible){var t=e.find(".child-comments"),n=t.find(".comment").not(".hidden"),a=t.find("li.toggle-all");if(n.removeClass("togglable-reply"),0===this.options.maxRepliesVisible)var i=n;else i=n.slice(0,-this.options.maxRepliesVisible);if(i.addClass("togglable-reply"),a.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)&&i.addClass("visible"),n.length>this.options.maxRepliesVisible){if(!a.length){a=w("<li/>",{class:"toggle-all highlight-font-bold"});var o=w("<span/>",{class:"text"}),s=w("<span/>",{class:"caret"});a.append(o).append(s),t.prepend(a)}this.setToggleAllButtonText(a,!1)}else a.remove()}},updateToggleAllButtons:function(){var n=this,e=this.$el.find("#comment-list");e.find(".comment").removeClass("visible"),e.children(".comment").each(function(e,t){n.updateToggleAllButton(w(t))})},sortComments:function(e,i){var o=this;"popularity"==i?e.sort(function(e,t){var n=e.childs.length,a=t.childs.length;if(o.options.enableUpvoting&&(n+=e.upvoteCount,a+=t.upvoteCount),a!=n)return a-n;var i=new Date(e.created).getTime();return new Date(t.created).getTime()-i}):e.sort(function(e,t){var n=new Date(e.created).getTime(),a=new Date(t.created).getTime();return"oldest"==i?n-a:a-n})},sortAndReArrangeComments:function(e){var a=this.$el.find("#comment-list"),t=this.getComments().filter(function(e){return!e.parent});this.sortComments(t,e),w(t).each(function(e,t){var n=a.find("> li.comment[data-id="+t.id+"]");a.append(n)})},showActiveSort:function(){var e=this.$el.find('.navigation li[data-sort-key="'+this.currentSortKey+'"]');this.$el.find(".navigation li").removeClass("active"),e.addClass("active");var t=this.$el.find(".navigation .title");if("attachments"!=this.currentSortKey)t.addClass("active"),t.find("header").html(e.first().html());else{var n=this.$el.find(".navigation ul.dropdown").children().first();t.find("header").html(n.html())}this.showActiveContainer()},forceResponsive:function(){this.$el.addClass("responsive")},closeDropdowns:function(){this.$el.find(".dropdown").hide()},saveOnKeydown:function(e){if(13==e.keyCode){var t=e.metaKey||e.ctrlKey;if(this.options.postCommentOnEnter||t)w(e.currentTarget).siblings(".control-row").find(".save").trigger("click"),e.stopPropagation(),e.preventDefault()}},saveEditableContent:function(e){var t=w(e.currentTarget);t.data("before",t.html())},checkEditableContentForChange:function(e){var t=w(e.currentTarget);w(t[0].childNodes).each(function(){this.nodeType==Node.TEXT_NODE&&0==this.length&&this.removeNode&&this.removeNode()}),t.data("before")!=t.html()&&(t.data("before",t.html()),t.trigger("change"))},navigationElementClicked:function(e){var t=w(e.currentTarget).data().sortKey;"attachments"!=t&&this.sortAndReArrangeComments(t),this.currentSortKey=t,this.showActiveSort()},toggleNavigationDropdown:function(e){e.stopPropagation(),w(e.currentTarget).find("~ .dropdown").toggle()},showMainCommentingField:function(e){var t=w(e.currentTarget);t.siblings(".control-row").show(),t.parent().find(".close").show(),t.parent().find(".upload.inline-button").hide(),t.focus()},hideMainCommentingField:function(e){var t=w(e.currentTarget),n=this.$el.find(".commenting-field.main .textarea"),a=this.$el.find(".commenting-field.main .control-row");this.clearTextarea(n),this.adjustTextareaHeight(n,!1),a.hide(),t.hide(),n.parent().find(".upload.inline-button").show(),n.blur(),this.options.includeAttachmentInPost&&t.closest(".commenting-field").find(".attachment-inline-wrapper").remove()},increaseTextareaHeight:function(e){var t=w(e.currentTarget);this.adjustTextareaHeight(t,!0)},textareaContentChanged:function(e){var t=w(e.currentTarget),n=t.siblings(".control-row").find(".save");if(!t.find(".reply-to.tag").length)if(t.attr("data-comment")){var a=t.parents("li.comment");if(1<a.length){var i=a.last().data("id");t.attr("data-parent",i)}}else{i=t.parents("li.comment").last().data("id");t.attr("data-parent",i)}var o=t.parents(".commenting-field").first();t[0].scrollHeight>t.outerHeight()?o.addClass("commenting-field-scrollable"):o.removeClass("commenting-field-scrollable");var s=!0,r=this.getTextareaContent(t,!0);if(commentModel=this.commentsById[t.attr("data-comment")]){var l,c=r!=commentModel.content;commentModel.parent&&(l=commentModel.parent.toString());var d=t.attr("data-parent")!=l;s=c||d}r.length&&s?n.addClass("enabled"):n.removeClass("enabled")},removeCommentingField:function(e){var t=w(e.currentTarget);t.siblings(".textarea").attr("data-comment")&&t.parents("li.comment").first().removeClass("edit"),t.parents(".commenting-field").first().remove()},removeImage:function(e){var t=w(e.currentTarget),n=t.closest(".commenting-field"),a=n.find(".control-row .save"),i=n.find(".upload");t.closest(".attachment-inline-wrapper").remove(),a.addClass("enabled"),i.addClass("enabled")},postComment:function(e){var t=this,n=w(e.currentTarget),a=n.parents(".commenting-field").first(),i=a.find(".textarea"),o=a.find(".attachment").data("attachment-model");a.addClass("posting-active"),n.removeClass("enabled");var s=this.createCommentJSON(i);this.options.includeAttachmentInPost&&(s.fileURL="",s.fileMimeType="",null!=o&&(s.fileURL=o.fileURL,s.fileMimeType=o.fileMimeType)),s=this.applyExternalMappings(s);this.options.postComment(s,function(e){t.createComment(e),a.find(".close").trigger("click"),a.removeClass("posting-active")},function(){n.addClass("enabled")})},createComment:function(e){var t=this.createCommentModel(e);this.addCommentToDataModel(t),this.addComment(t)},putComment:function(e){var n=this,t=w(e.currentTarget),a=t.parents(".commenting-field").first(),i=a.find(".textarea"),o=a.find(".attachment").data("attachment-model");a.addClass("posting-active"),t.removeClass("enabled");var s=w.extend({},this.commentsById[i.attr("data-comment")]);w.extend(s,{parent:i.attr("data-parent")||null,content:this.getTextareaContent(i),pings:this.getPings(i),modified:(new Date).getTime()}),this.options.includeAttachmentInPost&&(s.fileURL="",s.fileMimeType="",null!=o&&(s.fileURL=o.fileURL,s.fileMimeType=o.fileMimeType)),s=this.applyExternalMappings(s);this.options.putComment(s,function(e){var t=n.createCommentModel(e);delete t.childs,n.updateCommentModel(t),a.find(".close").trigger("click"),a.removeClass("posting-active"),n.reRenderComment(t.id)},function(){t.addClass("enabled")})},deleteComment:function(e){var t=this,n=w(e.currentTarget),a=n.parents(".comment").first(),i=w.extend({},this.commentsById[a.attr("data-id")]),o=i.id,s=i.parent;n.removeClass("enabled"),i=this.applyExternalMappings(i);this.options.deleteComment(i,function(){t.removeComment(o),s&&t.reRenderCommentActionBar(s)},function(){n.addClass("enabled")})},hashtagClicked:function(e){var t=w(e.currentTarget).attr("data-value");this.options.hashtagClicked(t)},pingClicked:function(e){var t=w(e.currentTarget).attr("data-value");this.options.pingClicked(t)},fileInputChanged:function(e,t){t=e.currentTarget.files;var n=w(e.currentTarget).parents(".commenting-field").first();this.uploadAttachments(t,n)},upvoteComment:function(e){var t,n=this,a=w(e.currentTarget).parents("li.comment").first().data().model,i=a.upvoteCount;t=a.userHasUpvoted?i-1:i+1,a.userHasUpvoted=!a.userHasUpvoted,a.upvoteCount=t,this.reRenderUpvotes(a.id);var o=w.extend({},a);o=this.applyExternalMappings(o);this.options.upvoteComment(o,function(e){var t=n.createCommentModel(e);n.updateCommentModel(t),n.reRenderUpvotes(t.id)},function(){a.userHasUpvoted=!a.userHasUpvoted,a.upvoteCount=i,n.reRenderUpvotes(a.id)})},toggleReplies:function(e){var t=w(e.currentTarget);t.siblings(".togglable-reply").toggleClass("visible"),this.setToggleAllButtonText(t,!0)},replyButtonClicked:function(e){var t=w(e.currentTarget),n=t.parents("li.comment").last(),a=t.parents(".comment").first().data().id,i=n.find(".child-comments > .commenting-field");if(i.length&&i.remove(),i.find(".textarea").attr("data-parent")!=a){i=this.createCommentingFieldElement(a),n.find(".child-comments").append(i);var o=i.find(".textarea");this.moveCursorToEnd(o);var s=this.options.scrollContainer.scrollTop(),r=s+i.position().top+i.outerHeight(),l=s+this.options.scrollContainer.outerHeight();if(l<r){var c=s+(r-l);this.options.scrollContainer.scrollTop(c)}}},editButtonClicked:function(e){var t=w(e.currentTarget).parents("li.comment").first(),n=t.data().model;t.addClass("edit");var a=this.createCommentingFieldElement(n.parent,n.id);if(t.find(".comment-wrapper").first().append(a),this.options.includeAttachmentInPost&&n.fileURL){var i=this.createAttachment(n);a.append(i)}var o=a.find(".textarea");o.attr("data-comment",n.id),n.content&&o.append(this.getFormattedCommentContent(n,!0)),this.moveCursorToEnd(o)},showDroppableOverlay:function(e){this.options.enableAttachments&&(this.$el.find(".droppable-overlay").css("top",this.$el[0].scrollTop),this.$el.find(".droppable-overlay").show(),this.$el.addClass("drag-ongoing"))},handleDragEnter:function(e){var t=w(e.currentTarget).data("dnd-count")||0;t++,w(e.currentTarget).data("dnd-count",t),w(e.currentTarget).addClass("drag-over")},handleDragLeave:function(e,t){var n=w(e.currentTarget).data("dnd-count");n--,w(e.currentTarget).data("dnd-count",n),0==n&&(w(e.currentTarget).removeClass("drag-over"),t&&t())},handleDragLeaveForOverlay:function(e){var t=this;this.handleDragLeave(e,function(){t.hideDroppableOverlay()})},handleDragLeaveForDroppable:function(e){this.handleDragLeave(e)},handleDragOverForOverlay:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},hideDroppableOverlay:function(){this.$el.find(".droppable-overlay").hide(),this.$el.removeClass("drag-ongoing")},handleDrop:function(e){e.preventDefault(),w(e.target).trigger("dragleave"),this.hideDroppableOverlay(),this.uploadAttachments(e.originalEvent.dataTransfer.files)},stopPropagation:function(e){e.stopPropagation()},createHTML:function(){var e=this.createMainCommentingFieldElement();this.$el.append(e),e.find(".control-row").hide(),e.find(".close").hide(),this.options.enableNavigation&&(this.$el.append(this.createNavigationElement()),this.showActiveSort());var t=this.createSpinner();this.$el.append(t);var n=w("<div/>",{class:"data-container","data-container":"comments"});this.$el.append(n);var a=w("<div/>",{class:"no-comments no-data",text:this.options.textFormatter(this.options.noCommentsText)}),i=w("<i/>",{class:"fa fa-comments fa-2x"});if(this.options.noCommentsIconURL.length&&(i.css("background-image",'url("'+this.options.noCommentsIconURL+'")'),i.addClass("image")),a.prepend(w("<br/>")).prepend(i),n.append(a),this.options.enableAttachments){var o=w("<div/>",{class:"data-container","data-container":"attachments"});this.$el.append(o);var s=w("<div/>",{class:"no-attachments no-data",text:this.options.textFormatter(this.options.noAttachmentsText)}),r=w("<i/>",{class:"fa fa-paperclip fa-2x"});this.options.attachmentIconURL.length&&(r.css("background-image",'url("'+this.options.attachmentIconURL+'")'),r.addClass("image")),s.prepend(w("<br/>")).prepend(r),o.append(s);var l=w("<div/>",{class:"droppable-overlay"}),c=w("<div/>",{class:"droppable-container"}),d=w("<div/>",{class:"droppable"}),p=w("<i/>",{class:"fa fa-paperclip fa-4x"});this.options.uploadIconURL.length&&(p.css("background-image",'url("'+this.options.uploadIconURL+'")'),p.addClass("image"));var m=w("<div/>",{text:this.options.textFormatter(this.options.attachmentDropText)});d.append(p),d.append(m),l.html(c.html(d)).hide(),this.$el.append(l)}},createProfilePictureElement:function(e,t){if(e)var n=w("<div/>").css({"background-image":"url("+e+")"});else n=w("<i/>",{class:"fa fa-user"});return n.addClass("profile-picture"),n.attr("data-user-id",t),this.options.roundProfilePictures&&n.addClass("round"),n},createMainCommentingFieldElement:function(){return this.createCommentingFieldElement(void 0,void 0,!0)},createCommentingFieldElement:function(e,t,n){var l=this,a=w("<div/>",{class:"commenting-field"});if(n&&a.addClass("main"),t)var i=this.commentsById[t].profilePictureURL,o=this.commentsById[t].creator;else i=this.options.profilePictureURL,o=this.options.creator;var s=this.createProfilePictureElement(i,o),r=w("<div/>",{class:"textarea-wrapper"}),c=w("<div/>",{class:"control-row"}),d=w("<div/>",{class:"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:!0});this.adjustTextareaHeight(d,!1);var p=w("<span/>",{class:"close inline-button"}).append(w('<span class="left"/>')).append(w('<span class="right"/>'));if(t){var m=this.options.textFormatter(this.options.saveText),h=w("<span/>",{class:"delete",text:this.options.textFormatter(this.options.deleteText)}).css("background-color",this.options.deleteButtonColor);c.append(h),this.isAllowedToDelete(t)&&h.addClass("enabled")}else{m=this.options.textFormatter(this.options.sendText);if(this.options.enableAttachments){var u=w("<span/>",{class:"enabled upload"}),f=w("<i/>",{class:"fa fa-paperclip"}),g=w("<input/>",{type:"file","data-role":"none"});w.browser.mobile||this.options.includeAttachmentInPost||g.attr("multiple","multiple"),this.options.uploadIconURL.length&&(f.css("background-image",'url("'+this.options.uploadIconURL+'")'),f.addClass("image")),u.append(f).append(g),c.append(u.clone()),n&&r.append(u.clone().addClass("inline-button"))}}var v=w("<span/>",{class:(t?"update":"send")+" save highlight-background",text:m});if(c.prepend(v),r.append(p).append(d).append(c),a.append(s).append(r),e){d.attr("data-parent",e);var C=this.commentsById[e];if(C.parent){d.html("&nbsp;");var b="@"+C.fullname,x=this.createTagElement(b,"reply-to",C.creator,{"data-user-id":C.creator});d.prepend(x)}}return this.options.enablePinging&&(d.textcomplete([{match:/(^|\s)@([^@]*)$/i,index:2,search:function(e,t){e=l.normalizeSpaces(e);l.options.searchUsers(e,t,function(){t([])})},template:function(e){var t=w("<div/>"),n=l.createProfilePictureElement(e.profile_picture_url),a=w("<div/>",{class:"details"}),i=w("<div/>",{class:"name"}).html(e.fullname),o=w("<div/>",{class:"email"}).html(e.email);return e.email?a.append(i).append(o):(a.addClass("no-email"),a.append(i)),t.append(n).append(a),t.html()},replace:function(e){return" "+l.createTagElement("@"+e.fullname,"ping",e.id,{"data-user-id":e.id})[0].outerHTML+" "}}],{appendTo:".jquery-comments",dropdownClassName:"dropdown autocomplete",maxCount:5,rightEdgeOffset:0,debounce:250}),w.fn.textcomplete.Dropdown.prototype.render=function(e){var t=this._buildContents(e),n=w.map(e,function(e){return e.value});if(e.length){var a=e[0].strategy;a.id?this.$el.attr("data-strategy",a.id):this.$el.removeAttr("data-strategy"),this._renderHeader(n),this._renderFooter(n),t&&(this._renderContents(t),this._fitToBottom(),this._fitToRight(),this._activateIndexedItem()),this._setScroll()}else this.noResultsMessage?this._renderNoResultsMessage(n):this.shown&&this.deactivate();var i=parseInt(this.$el.css("top"))+l.options.scrollContainer.scrollTop();this.$el.css("top",i);var o=this.$el.css("left");this.$el.css("left",0);var s=l.$el.width()-this.$el.outerWidth(),r=Math.min(s,parseInt(o));this.$el.css("left",r)},w.fn.textcomplete.ContentEditable.prototype._skipSearch=function(e){switch(e.keyCode){case 9:case 13:case 16:case 17:case 33:case 34:case 40:case 38:case 27:return!0}if(e.ctrlKey)switch(e.keyCode){case 78:case 80:return!0}}),a},createNavigationElement:function(){var e=w("<ul/>",{class:"navigation"}),t=w("<div/>",{class:"navigation-wrapper"});e.append(t);var n=w("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest","data-container-name":"comments"}),a=w("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest","data-container-name":"comments"}),i=w("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity","data-container-name":"comments"}),o=w("<li/>",{text:this.options.textFormatter(this.options.attachmentsText),"data-sort-key":"attachments","data-container-name":"attachments"}),s=w("<i/>",{class:"fa fa-paperclip"});this.options.attachmentIconURL.length&&(s.css("background-image",'url("'+this.options.attachmentIconURL+'")'),s.addClass("image")),o.prepend(s);var r=w("<div/>",{class:"navigation-wrapper responsive"}),l=w("<ul/>",{class:"dropdown"}),c=w("<li/>",{class:"title"}),d=w("<header/>");return c.append(d),r.append(c),r.append(l),e.append(r),t.append(n).append(a),l.append(n.clone()).append(a.clone()),(this.options.enableReplying||this.options.enableUpvoting)&&(t.append(i),l.append(i.clone())),this.options.enableAttachments&&(t.append(o),r.append(o.clone())),this.options.forceResponsive&&this.forceResponsive(),e},createSpinner:function(){var e=w("<div/>",{class:"spinner"}),t=w("<i/>",{class:"fa fa-spinner fa-spin"});return this.options.spinnerIconURL.length&&(t.css("background-image",'url("'+this.options.spinnerIconURL+'")'),t.addClass("image")),e.html(t),e},createCommentElement:function(e){var t=w("<li/>",{"data-id":e.id,class:"comment"}).data("model",e);e.createdByCurrentUser&&t.addClass("by-current-user"),e.createdByAdmin&&t.addClass("by-admin");var n=w("<ul/>",{class:"child-comments"}),a=this.createCommentWrapperElement(e);return t.append(a),null==e.parent&&t.append(n),t},createCommentWrapperElement:function(e){var t=w("<div/>",{class:"comment-wrapper"}),n=this.createProfilePictureElement(e.profilePictureURL,e.creator),a=w("<time/>",{text:this.options.timeFormatter(e.created),"data-original":e.created}),i=w("<span/>",{"data-user-id":e.creator,text:e.createdByCurrentUser?this.options.textFormatter(this.options.youText):e.fullname});e.profileURL&&(i=w("<a/>",{href:e.profileURL,html:i}));var o=w("<div/>",{class:"name",html:i});if(e.createdByAdmin&&o.addClass("highlight-font-bold"),e.parent){var s=this.commentsById[e.parent];if(s.parent){var r=w("<span/>",{class:"reply-to",text:s.fullname,"data-user-id":s.creator}),l=w("<i/>",{class:"fa fa-share"});this.options.replyIconURL.length&&(l.css("background-image",'url("'+this.options.replyIconURL+'")'),l.addClass("image")),r.prepend(l),o.append(r)}}if(e.isNew){var c=w("<span/>",{class:"new highlight-background",text:this.options.textFormatter(this.options.newText)});o.append(c)}var d=w("<div/>",{class:"wrapper"}),p=w("<div/>",{class:"content"}),m=null!=e.fileURL&&""!=e.fileURL;if((!m||1==this.options.includeAttachmentInPost&&e.content)&&p.html(this.getFormattedCommentContent(e)),m){var h=this.createAttachment(e);1==this.options.includeAttachmentInPost?p.append(h):p.html(h)}if(e.modified&&e.modified!=e.created){var u=this.options.timeFormatter(e.modified),f=w("<time/>",{class:"edited",text:this.options.textFormatter(this.options.editedText)+" "+u,"data-original":e.modified});p.append(f)}var g=w("<span/>",{class:"actions"}),v=w("<span/>",{class:"separator",text:"·"}),C=w("<button/>",{class:"action reply",type:"button",text:this.options.textFormatter(this.options.replyText)}),b=w("<i/>",{class:"fa fa-thumbs-up"});this.options.upvoteIconURL.length&&(b.css("background-image",'url("'+this.options.upvoteIconURL+'")'),b.addClass("image"));var x=this.createUpvoteElement(e);if(this.options.enableReplying&&g.append(C),this.options.enableUpvoting&&g.append(x),e.createdByCurrentUser||this.options.currentUserIsAdmin){if(m||this.options.includeAttachmentInPost&&this.isAllowedToDelete(e.id)){var y=w("<button/>",{class:"action delete enabled",type:"button",text:this.options.textFormatter(this.options.deleteText)});g.append(y)}if((!m||this.options.includeAttachmentInPost)&&this.options.enableEditing){var T=w("<button/>",{class:"action edit",type:"button",text:this.options.textFormatter(this.options.editText)});g.append(T)}}return g.children().each(function(e,t){w(t).is(":last-child")||w(t).after(v.clone())}),d.append(p),d.append(g),t.append(n).append(a).append(o).append(d),t},createAttachment:function(e,t){var n=null,a=null;if(e.fileMimeType){var i=e.fileMimeType.split("/");2==i.length&&(n=i[1],a=i[0])}var o=w("<a/>",{class:"attachment",href:e.fileURL,target:"_blank",data:{"attachment-model":e}});if("image"==a){var s=w("<img/>",{src:e.fileURL});o.html(s)}else if("video"==a){var r=w("<video/>",{src:e.fileURL,type:e.fileMimeType,controls:"controls"});o.html(r)}else{var l=["archive","audio","code","excel","image","movie","pdf","photo","picture","powerpoint","sound","video","word","zip"],c="fa fa-file-o";0<l.indexOf(n)?c="fa fa-file-"+n+"-o":0<l.indexOf(a)&&(c="fa fa-file-"+a+"-o");var d=w("<i/>",{class:c});this.options.fileIconURL.length&&(d.css("background-image",'url("'+this.options.fileIconURL+'")'),d.addClass("image"));var p=e.fileURL.split("/"),m=p[p.length-1];m=m.split("?")[0],m=decodeURIComponent(m),o.text(m),o.prepend(d)}var h=w("<div/>",{class:"attachment-inline-wrapper"}),u=w("<span/>",{class:"delete inline-button"}).append(w('<span class="left"/>')).append(w('<span class="right"/>'));return h.append(o),h.append(u),h},createUpvoteElement:function(e){var t=w("<i/>",{class:"fa fa-thumbs-up"});return this.options.upvoteIconURL.length&&(t.css("background-image",'url("'+this.options.upvoteIconURL+'")'),t.addClass("image")),w("<button/>",{class:"action upvote"+(e.userHasUpvoted?" highlight-font":"")}).append(w("<span/>",{text:e.upvoteCount,class:"upvote-count"})).append(t)},createTagElement:function(e,t,n,a){var i=w("<input/>",{class:"tag",type:"button","data-role":"none"});return t&&i.addClass(t),i.val(e),i.attr("data-value",n),a&&i.attr(a),i},reRenderComment:function(e){var a=this.commentsById[e],t=this.$el.find('li.comment[data-id="'+a.id+'"]'),i=this;t.each(function(e,t){var n=i.createCommentWrapperElement(a);w(t).find(".comment-wrapper").first().replaceWith(n)})},reRenderCommentActionBar:function(e){var a=this.commentsById[e],t=this.$el.find('li.comment[data-id="'+a.id+'"]'),i=this;t.each(function(e,t){var n=i.createCommentWrapperElement(a);w(t).find(".actions").first().replaceWith(n.find(".actions"))})},reRenderUpvotes:function(e){var a=this.commentsById[e],t=this.$el.find('li.comment[data-id="'+a.id+'"]'),i=this;t.each(function(e,t){var n=i.createUpvoteElement(a);w(t).find(".upvote").first().replaceWith(n)})},createCssDeclarations:function(){w("head style.jquery-comments-css").remove(),this.createCss(".jquery-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments ul.navigation ul.dropdown li.active {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-background {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-font {color: "+this.options.highlightColor+" !important;}"),this.createCss(".jquery-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(e){var t=w("<style/>",{type:"text/css",class:"jquery-comments-css",text:e});w("head").append(t)},getComments:function(){var t=this;return Object.keys(this.commentsById).map(function(e){return t.commentsById[e]})},getChildComments:function(t){return this.getComments().filter(function(e){return e.parent==t})},getAttachments:function(){return this.getComments().filter(function(e){return null!=e.fileURL})},getOutermostParent:function(e){var t=e;do{var n=this.commentsById[t];t=n.parent}while(null!=n.parent);return n},createCommentJSON:function(e){var t=(new Date).toISOString();return{id:"c"+(this.getComments().length+1),parent:e.attr("data-parent")||null,created:t,modified:t,content:this.getTextareaContent(e),pings:this.getPings(e),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:!0,upvoteCount:0,userHasUpvoted:!1}},isAllowedToDelete:function(n){if(this.options.enableDeleting){var a=!0;return this.options.enableDeletingCommentWithReplies||w(this.getComments()).each(function(e,t){t.parent==n&&(a=!1)}),a}return!1},setToggleAllButtonText:function(n,e){function t(){var e=a.options.textFormatter(a.options.viewAllRepliesText),t=n.siblings(".comment").not(".hidden").length;e=e.replace("__replyCount__",t),i.text(e)}var a=this,i=n.find("span.text"),o=n.find(".caret"),s=this.options.textFormatter(this.options.hideRepliesText);e?(i.text()==s?t():i.text(s),o.toggleClass("up")):i.text()!=s&&t()},adjustTextareaHeight:function(e,t){e=w(e);var n,a=1==t?this.options.textareaRowsOnFocus:this.options.textareaRows;do{void 0,n=2.2+1.45*(a-1),e.css("height",n+"em"),a++;var i=e[0].scrollHeight>e.outerHeight(),o=0!=this.options.textareaMaxRows&&a>this.options.textareaMaxRows}while(i&&!o)},clearTextarea:function(e){e.empty().trigger("input")},getTextareaContent:function(e,t){var n=e.clone();n.find(".reply-to.tag").remove(),n.find(".tag.hashtag").replaceWith(function(){return t?w(this).val():"#"+w(this).attr("data-value")}),n.find(".tag.ping").replaceWith(function(){return t?w(this).val():"@"+w(this).attr("data-value")});var a=w("<pre/>").html(n.html());a.find("div, p, br").replaceWith(function(){return"\n"+this.innerHTML});var i=a.text().replace(/^\s+/g,"");return i=this.normalizeSpaces(i)},getFormattedCommentContent:function(e,t){var n=this.escape(e.content);return n=this.linkify(n),n=this.highlightTags(e,n),t&&(n=n.replace(/(?:\n)/g,"<br>")),n},getPings:function(e){var i={};return e.find(".ping").each(function(e,t){var n=parseInt(w(t).attr("data-value")),a=w(t).val();i[n]=a.slice(1)}),i},moveCursorToEnd:function(e){if(e=w(e)[0],w(e).trigger("input"),w(e).scrollTop(e.scrollHeight),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}else if(void 0!==document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}e.focus()},escape:function(e){return w("<pre/>").text(this.normalizeSpaces(e)).html()},normalizeSpaces:function(e){return e.replace(new RegExp(" ","g")," ")},after:function(e,t){var n=this;return function(){if(0==--e)return t.apply(n,arguments)}},highlightTags:function(e,t){return this.options.enableHashtags&&(t=this.highlightHashtags(e,t)),this.options.enablePinging&&(t=this.highlightPings(e,t)),t},highlightHashtags:function(e,t){var a=this;if(-1!=t.indexOf("#")){t=t.replace(/(^|\s)#([a-zäöüß\d-_]+)/gim,function(e,t,n){return t+function(e){return(e=a.createTagElement("#"+e,"hashtag",e))[0].outerHTML}(n)})}return t},highlightPings:function(a,i){var o=this;if(-1!=i.indexOf("@")){w(Object.keys(a.pings)).each(function(e,t){var n="@"+a.pings[t];i=i.replace(new RegExp(n,"g"),function(e,t){return o.createTagElement(e,"ping",t,{"data-user-id":t})[0].outerHTML}(n,t))})}return i},linkify:function(e){var t,n,a,i;if(n=/(\b(https?|ftp|file):\/\/[-A-ZÄÖÅ0-9+&@#\/%?=~_|!:,.;]*[-A-ZÄÖÅ0-9+&@#\/%=~_|])/gim,a=/(^|[^\/f])(www\.[-A-ZÄÖÅ0-9+&@#\/%?=~_|!:,.;]*[-A-ZÄÖÅ0-9+&@#\/%=~_|])/gim,i=/(([A-ZÄÖÅ0-9\-\_\.])+@[A-ZÄÖÅ\_]+?(\.[A-ZÄÖÅ]{2,6})+)/gim,t=(t=(t=e.replace(n,'<a href="$1" target="_blank">$1</a>')).replace(a,'$1<a href="https://$2" target="_blank">$2</a>')).replace(i,'<a href="mailto:$1">$1</a>'),0<(e.match(/<a href/g)||[]).length){for(var o=e.split(/(<\/a>)/g),s=0;s<o.length;s++)null==o[s].match(/<a href/g)&&(o[s]=o[s].replace(n,'<a href="$1" target="_blank">$1</a>').replace(a,'$1<a href="https://$2" target="_blank">$2</a>').replace(i,'<a href="mailto:$1">$1</a>'));return o.join("")}return t},waitUntil:function(e,t){var n=this;e()?t():setTimeout(function(){n.waitUntil(e,t)},100)},applyInternalMappings:function(e){var t={},n=this.options.fieldMappings;for(var a in n)n.hasOwnProperty(a)&&(t[n[a]]=a);return this.applyMappings(t,e)},applyExternalMappings:function(e){var t=this.options.fieldMappings;return this.applyMappings(t,e)},applyMappings:function(e,t){var n={};for(var a in t){if(a in e)n[e[a]]=t[a]}return n}};w.fn.comments=function(t){return this.each(function(){var e=Object.create(n);w.data(this,"comments",e),e.init(t||{},this)})}});